<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor MakeCode - Gnius Space</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }

        /* Contenedor del chat embebido */
        #chat-container {
            width: 100%;
            max-width: 400px;
            height: 600px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            background: white;
        }

        /* Ocultar el iframe de MakeCode */
        #makecode-renderer {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
        }

        /* Modal de pantalla completa */
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 99999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .fullscreen-modal.active {
            display: flex;
        }

        .fullscreen-modal img {
            max-width: 95%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(255,255,255,0.1);
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .fullscreen-close:hover {
            opacity: 1;
        }

        .fullscreen-hint {
            color: rgba(255,255,255,0.6);
            margin-top: 15px;
            font-size: 14px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Tutor de micro:bit</h1>
        <p>Aprende programaci√≥n por bloques con tu asistente AI</p>
    </div>

    <!-- Contenedor donde se incrustar√° el chat -->
    <div id="chat-container"></div>

    <!-- Modal para pantalla completa -->
    <div class="fullscreen-modal" id="fullscreen-modal">
        <button class="fullscreen-close" onclick="closeFullscreen()">&times;</button>
        <img id="fullscreen-img" src="" alt="Bloques MakeCode">
        <p class="fullscreen-hint">Presiona ESC o haz clic en √ó para cerrar</p>
    </div>

    <!-- IFrame oculto de MakeCode para renderizado -->
    <iframe 
        id="makecode-renderer" 
        src="https://makecode.microbit.org/--docs?render=1"
        sandbox="allow-scripts allow-same-origin"
    ></iframe>

    <script>
        // ========================================
        // FUNCIONES DE PANTALLA COMPLETA
        // ========================================
        function openFullscreen(imgSrc) {
            const modal = document.getElementById('fullscreen-modal');
            const img = document.getElementById('fullscreen-img');
            img.src = imgSrc;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreen() {
            const modal = document.getElementById('fullscreen-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Cerrar con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeFullscreen();
        });

        // Cerrar al hacer clic fuera de la imagen
        document.getElementById('fullscreen-modal').addEventListener('click', (e) => {
            if (e.target.id === 'fullscreen-modal') closeFullscreen();
        });

        // ========================================
        // MOTOR DE RENDERIZADO DE MAKECODE
        // ========================================
        window.MakeCodeRenderer = {
            iframe: null,
            isReady: false,
            queue: [],
            callbacks: {},
            requestId: 0,

            init: function() {
                this.iframe = document.getElementById('makecode-renderer');
                
                window.addEventListener('message', (event) => {
                    if (!event.origin.includes('makecode.microbit.org')) return;
                    
                    const data = event.data;
                    if (data.source !== 'makecode') return;

                    console.log('üì® MakeCode:', data.type);

                    if (data.type === 'renderready') {
                        console.log('‚úÖ MakeCode Renderer listo');
                        this.isReady = true;
                        this.processQueue();
                    } 
                    else if (data.type === 'renderblocks') {
                        const callback = this.callbacks[data.id];
                        if (callback) {
                            callback(data);
                            delete this.callbacks[data.id];
                        }
                    }
                });

                console.log('üöÄ MakeCode Renderer inicializado');
            },

            render: function(code) {
                return new Promise((resolve, reject) => {
                    const id = 'render-' + (this.requestId++);
                    
                    this.callbacks[id] = (response) => {
                        if (response.uri) {
                            resolve({
                                uri: response.uri,
                                width: response.width,
                                height: response.height,
                                svg: response.svg
                            });
                        } else {
                            reject(new Error('Error al renderizar bloques'));
                        }
                    };

                    const message = {
                        type: 'renderblocks',
                        id: id,
                        code: code,
                        options: {
                            snippetMode: true
                        }
                    };

                    if (this.isReady) {
                        this.sendMessage(message);
                    } else {
                        this.queue.push(message);
                    }

                    setTimeout(() => {
                        if (this.callbacks[id]) {
                            delete this.callbacks[id];
                            reject(new Error('Timeout al renderizar'));
                        }
                    }, 15000);
                });
            },

            sendMessage: function(message) {
                if (this.iframe && this.iframe.contentWindow) {
                    this.iframe.contentWindow.postMessage(
                        message, 
                        'https://makecode.microbit.org'
                    );
                }
            },

            processQueue: function() {
                while (this.queue.length > 0) {
                    const msg = this.queue.shift();
                    this.sendMessage(msg);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            window.MakeCodeRenderer.init();
        });

        // ========================================
        // EXTENSI√ìN DE VOICEFLOW PARA MAKECODE
        // ========================================
        const MakeCodeBlocksExtension = {
            name: 'MakeCodeBlocks',
            type: 'response',
            
            match: ({ trace }) => {
                return trace.type === 'render_blocks' || 
                       trace.type === 'ext_render_blocks' ||
                       trace.type === 'RENDER_MAKECODE_BLOCKS' ||
                       (trace.payload && trace.payload.name === 'render_blocks') ||
                       (trace.payload && trace.payload.type === 'render_blocks');
            },
            
            render: async ({ trace, element }) => {
                const payload = trace.payload || {};
                
                // Extraer c√≥digo de m√∫ltiples ubicaciones posibles
                let code = payload.code || 
                           payload.body?.code || 
                           payload.data?.code ||
                           (typeof payload === 'string' ? payload : null);
                
                // Intentar parsear si body es string JSON
                if (!code && typeof payload.body === 'string') {
                    try {
                        const parsed = JSON.parse(payload.body);
                        code = parsed.code;
                    } catch(e) {}
                }
                
                if (!code) {
                    element.innerHTML = '<div style="color:#e53e3e;padding:10px;text-align:center;">No se recibi√≥ c√≥digo</div>';
                    return;
                }
                
                // Crear contenedor principal
                const container = document.createElement('div');
                container.style.cssText = `
                    background: #ffffff;
                    border-radius: 12px;
                    padding: 12px;
                    margin: 8px 0;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    width: 100%;
                    max-width: 100%;
                `;
                
                // Loader
                container.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:center;padding:20px;color:#666;font-size:14px;">
                        <div style="width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;"></div>
                        <span>Generando bloques...</span>
                    </div>
                `;
                element.appendChild(container);

                try {
                    const result = await window.MakeCodeRenderer.render(code);
                    
                    // Estado inicial: escalado (fit)
                    let isScaleMode = true;
                    
                    // Contenedor de la imagen
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = `
                        width: 100%;
                        overflow: hidden;
                        border-radius: 8px;
                        background: #f8f9fa;
                        position: relative;
                    `;
                    
                    // Imagen
                    const img = document.createElement('img');
                    img.src = result.uri;
                    img.alt = 'Bloques de MakeCode';
                    
                    // Funci√≥n para aplicar estilos seg√∫n modo
                    const applyImageStyle = () => {
                        if (isScaleMode) {
                            img.style.cssText = `
                                width: 100% !important;
                                max-width: 100% !important;
                                height: auto !important;
                                display: block;
                                margin: 0 auto;
                                cursor: zoom-in;
                            `;
                            imgWrapper.style.overflowX = 'hidden';
                        } else {
                            img.style.cssText = `
                                width: auto;
                                max-width: none;
                                height: auto;
                                display: block;
                                cursor: grab;
                            `;
                            imgWrapper.style.overflowX = 'auto';
                        }
                    };
                    
                    applyImageStyle();
                    
                    // Click en imagen para pantalla completa (solo en modo escalar)
                    img.onclick = () => {
                        if (isScaleMode) {
                            openFullscreen(result.uri);
                        }
                    };
                    
                    imgWrapper.appendChild(img);
                    
                    // Barra de botones
                    const buttonBar = document.createElement('div');
                    buttonBar.style.cssText = `
                        display: flex;
                        gap: 6px;
                        margin-top: 10px;
                        flex-wrap: wrap;
                    `;
                    
                    // Estilo com√∫n para botones
                    const btnStyle = `
                        padding: 6px 10px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 11px;
                        transition: background 0.2s;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    `;
                    
                    // Bot√≥n Toggle Escalar/Scroll
                    const toggleBtn = document.createElement('button');
                    toggleBtn.innerHTML = '‚ÜîÔ∏è Scroll';
                    toggleBtn.style.cssText = btnStyle;
                    toggleBtn.onmouseover = () => toggleBtn.style.background = '#5a6fd6';
                    toggleBtn.onmouseout = () => toggleBtn.style.background = '#667eea';
                    toggleBtn.onclick = () => {
                        isScaleMode = !isScaleMode;
                        applyImageStyle();
                        toggleBtn.innerHTML = isScaleMode ? '‚ÜîÔ∏è Scroll' : 'üî≤ Escalar';
                        fullscreenBtn.style.display = isScaleMode ? 'flex' : 'none';
                    };
                    
                    // Bot√≥n Pantalla Completa
                    const fullscreenBtn = document.createElement('button');
                    fullscreenBtn.innerHTML = 'üîç Ampliar';
                    fullscreenBtn.style.cssText = btnStyle;
                    fullscreenBtn.onmouseover = () => fullscreenBtn.style.background = '#5a6fd6';
                    fullscreenBtn.onmouseout = () => fullscreenBtn.style.background = '#667eea';
                    fullscreenBtn.onclick = () => openFullscreen(result.uri);
                    
                    // Bot√≥n Copiar
                    const copyBtn = document.createElement('button');
                    copyBtn.innerHTML = 'üìã Copiar';
                    copyBtn.style.cssText = btnStyle;
                    copyBtn.onmouseover = () => copyBtn.style.background = '#5a6fd6';
                    copyBtn.onmouseout = () => copyBtn.style.background = '#667eea';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(code).then(() => {
                            copyBtn.innerHTML = '‚úÖ Copiado';
                            setTimeout(() => copyBtn.innerHTML = 'üìã Copiar', 2000);
                        });
                    };
                    
                    buttonBar.appendChild(toggleBtn);
                    buttonBar.appendChild(fullscreenBtn);
                    buttonBar.appendChild(copyBtn);
                    
                    // Details para ver c√≥digo
                    const details = document.createElement('details');
                    details.style.cssText = 'margin-top:10px;font-size:11px;';
                    details.innerHTML = `
                        <summary style="cursor:pointer;color:#666;padding:5px 0;">Ver c√≥digo TypeScript</summary>
                        <pre style="background:#f5f5f5;padding:10px;border-radius:4px;margin-top:5px;overflow-x:auto;font-size:11px;white-space:pre-wrap;word-break:break-all;">${code}</pre>
                    `;
                    
                    // Limpiar y agregar elementos
                    container.innerHTML = '';
                    container.appendChild(imgWrapper);
                    container.appendChild(buttonBar);
                    container.appendChild(details);
                    
                } catch (error) {
                    console.error('Error renderizando:', error);
                    container.innerHTML = `
                        <div style="color:#e53e3e;padding:10px;text-align:center;">‚ö†Ô∏è ${error.message}</div>
                        <pre style="background:#f5f5f5;padding:10px;border-radius:6px;font-size:11px;overflow-x:auto;">${code}</pre>
                    `;
                }
            }
        };

        // ========================================
        // INICIALIZAR VOICEFLOW EMBED
        // ========================================
        (function(d, t) {
            var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
            v.onload = function() {
                window.voiceflow.chat.load({
                    verify: { projectID: '693206aef4f3f8cfea18fd06' },
                    url: 'https://general-runtime.voiceflow.com',
                    versionID: 'production',
                    voice: {
                        url: "https://runtime-api.voiceflow.com"
                    },
                    render: {
                        mode: 'embedded',
                        target: document.getElementById('chat-container')
                    },
                    assistant: {
                        extensions: [MakeCodeBlocksExtension]
                    }
                });
            }
            v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
            v.type = "text/javascript";
            s.parentNode.insertBefore(v, s);
        })(document, 'script');
    </script>
</body>
</html>
